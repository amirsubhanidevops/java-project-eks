@Library('my-shared-library') _

pipeline {

    agent any

    parameters{
        choice(name:'action', choices: 'create\ndelete', description: 'choose create/Destroy')
        string(name: 'aws_acc_id', description:"name of the aws account id", defaultValue: '793555027847')
        string(name: 'region', description:"region of the ECR", defaultValue: 'us-east-1')
        string(name: 'ecr_name_repo', description:"name of the ECR repo", defaultValue: 'amirsubhani')
    }

    stages{

        stage('Git checkout'){
          when{expression {params.action == 'create'}}
            steps{
                script{

                    gitCheckout(
                        branch: "main",
                        url: "https://github.com/amirsubhanidevops/java-project-eks.git"
                    )
                }
            }

        }

        stage('Unit test : Maven'){
          when{expression {params.action == 'create'}}

            steps{
                script{

                    unitTest()
                }
            }

        }

        stage('Integration test : Maven'){
          when{expression {params.action == 'create'}}
            steps{
                script{

                    integrationTest()
                }
            }

        }

        stage('Static code analysis : Sonar'){
          when{expression {params.action == 'create'}}
            steps{
                script{

                    def SonarqubecredentialsId = 'sonarqube-api'
                    staticCodeAnalysis(SonarqubecredentialsId)

                }
            }

        }

        stage('Code Quality gate status check : Sonarqube'){
          when{expression {params.action == 'create'}}
            steps{
                script{

                def SonarqubecredentialsId = 'sonarqube-api'
                staticCodeAnalysis(SonarqubecredentialsId)
                }
            }

        }

        stage('MVN Build: Maven'){
          when{expression {params.action == 'create'}}
            steps{
                script{

                    mavenBuild()
                }
            }
     
           
        }  

        stage('Docker Image Build: ECR '){
          when{expression {params.action == 'create'}}
            steps{
                script{

                    dockerBuild("${params.aws_acc_id}","${params.region}","${params.ecr_name_repo}")
                }
            }

        }

        stage('Docker Image Scan: Trivy'){
          when{expression {params.action == 'create'}}
            steps{
                script{

                    dockerimageScan("${params.aws_acc_id}","${params.region}","${params.ecr_name_repo}")
                }
            }

        }

        stage('Docker Image push: ECR'){
          when{expression {params.action == 'create'}}
            steps{
                script{

                    dockerPush("${params.aws_acc_id}","${params.region}","${params.ecr_name_repo}")
                }
            }

        }

        stage('Docker Image ECR'){
          when{expression {params.action == 'create'}}
            steps{
                script{

                    dockerImageCleanup("${params.aws_acc_id}","${params.region}","${params.ecr_name_repo}")
                }
            }
        
        
        }


    }
    
}